---
title: "Community data cleaning"
author: "Richard J. Telford"
date: "November 7, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("conflicted")
library("tidyverse")
conflict_prefer("filter", "dplyr")
conflict_prefer("map", "purrr")
```

The Between the Fjords research group has several projects that repeatedly survey the vegetation composition of plots over several years. In any such dataset there are inevitably problems, such as synonynms, mis-identifications (sterile _Carex_ are a particular problem), or accidental omissions. 

![](https://betweenthefjords.w.uib.no/files/2015/11/Siri-Lie-Olsen-300x225.jpg)

We need to be able to identify these problems so we can try to correct them, but with over two hundred plots surveyed four or five times, each with about 20 taxa, it is a huge job.

To make the task easier, we developed turf-maps that plot each taxon per turf per year. Since other people probably have similar data, and would find our code useful, I'm going to show how we do it using some data from the [LandPress project](https://www.uib.no/en/rg/EECRG/95156/landpress) which studies how climate and land-use change affects biodiversity and natural resources in Norwegian coastal heathlands. 

For each 1m^2^ turf, vegetation cover is estimated on a percent scale, and presence/absence is recorded on a 4 x 4 sub-turf grid. The data look like this

```{r load-data}
library("tidyverse")
community <- readRDS("data/community.RDS")

community %>% slice(1:10) %>% 
  select(site:freq5) %>%
  knitr::kable()
```


We need to reformat the data with `tidyr::pivot_longer` to make put it into a long format suitable for plotting (see [](https://www.fromthebottomoftheheap.net/2019/10/25/pivoting-tidily)/)

```{r pivot-long}
community_long <- community %>% 
  pivot_longer(cols = matches("^freq\\d+$"), 
               names_to = "subturf", 
               values_to = "presence", 
               names_prefix = "freq", 
               names_ptypes = list(subturf = integer())) %>% 
  filter(presence != "0")

#first few columns
community_long %>% slice(1:10) %>% 
  knitr::kable()
```


The subturfs are counted from top-left of the turf like the words on a page. We need to map these onto row/column positions so we can plot them which can be done with `%%` and `%/%`

Quick reminder:

```{r modulo}
# Integer division
21 %/% 4

# Remainder after integer division
21 %% 4
```


```{r sub-turfmap}
grid <- 4 # number of rows/colums of subturfs

tibble(subturf = 1:grid^2) %>% 
ggplot(aes(x = (subturf - 1) %% grid, #column number
           y = grid - ((subturf - 1) %/% grid), #row number
           label = subturf)) +
  geom_tile(colour = "grey60", fill = "grey90", show.legend = FALSE, alpha = .8) +
  geom_text() +
  scale_x_continuous(expand = c(0, 0)) +  
  scale_y_continuous(expand = c(0, 0)) +
  coord_equal() +
  theme(axis.text = element_blank(), axis.ticks = element_blank())
```

Now 

```{r one_plot, fig.height=10}
make_turf_plot <- function(data, title, grid = 5){ 
  ggplot(data, aes(x = (subturf - 1) %% grid, 
                   y = grid - ((subturf - 1) %/% grid), 
                   fill = cover)) +
    geom_tile(colour = "grey60") +
    facet_grid(species ~ year) +
    ggtitle(title) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_fill_distiller(type = "seq", palette = "Greens", direction = 1) + 
    theme_bw() +
    theme(
      axis.text = element_blank(), 
      axis.title = element_blank(), 
      axis.ticks = element_blank(),
      panel.spacing.y = unit(0.04, "lines"),
      panel.grid.minor = element_blank(),
      strip.text.y = element_text(angle = 0)
      )
  }

community_long %>%
  filter(plot == "10.1.") %>%
  make_turf_plot(title = glue::glue("Site {.$site}: plot {.$plot}"), grid = 4)
```

There are a few things than need checking here, for example, _Agrostis capillaris_ vs. _Agrostis sp_, _Festuca_, and _Rhytidiadelphus_.

#Subturf maps

There are lots of turfs, and I want to be able to print them all at once which I can do using the `purrr` package to iterate over the data. For speed, I could use `furrr::future_pmap`, which allows parallel processing, but it doesn't currently play nicely with Rstudio.


```{r many_plots, eval = TRUE, fig.height=11, fig.width = 7, warning=FALSE}

x <- community_long %>% 
  # sort
  arrange(site, plot) %>% 
  group_by(site, plot) %>% 
  nest() %>% 
  {pmap(
    .l = list(data = .$data, title = glue::glue("Site {.$site}: plot {.$plot}")),
    .f = make_turf_plot, 
    grid = 4
    )} %>% 
  walk(print) #print all maps
```

If the plots aren't large enough, change `fig.height` in the chunk options.

